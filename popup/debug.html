<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Popup Debug</title>
  <style>
    body {
      width: 400px;
      padding: 20px;
      font-family: monospace;
      font-size: 12px;
    }
    .status { margin: 10px 0; padding: 10px; border: 1px solid #ccc; }
    .pass { background: #d4edda; border-color: #c3e6cb; }
    .fail { background: #f8d7da; border-color: #f5c6cb; }
    .info { background: #d1ecf1; border-color: #bee5eb; }
    pre { margin: 5px 0; white-space: pre-wrap; word-wrap: break-word; }
  </style>
</head>
<body>
  <h2>Popup Debug Tool</h2>
  <div id="results"></div>

  <script type="module">
    const results = document.getElementById('results');

    function log(message, type = 'info') {
      const div = document.createElement('div');
      div.className = `status ${type}`;
      div.innerHTML = `<pre>${message}</pre>`;
      results.appendChild(div);
    }

    async function runDiagnostics() {
      log('ðŸ” Starting diagnostics...', 'info');

      // 1. Check chrome API availability
      try {
        log(`âœ“ chrome.runtime.id: ${chrome.runtime.id}`, 'pass');
      } catch (e) {
        log(`âœ— chrome.runtime.id error: ${e.message}`, 'fail');
      }

      // 2. Check chrome.storage
      try {
        await chrome.storage.local.set({ test: 'value' });
        const result = await chrome.storage.local.get('test');
        log(`âœ“ chrome.storage.local works: ${JSON.stringify(result)}`, 'pass');
      } catch (e) {
        log(`âœ— chrome.storage.local error: ${e.message}`, 'fail');
      }

      // 3. Test config module import
      try {
        const config = await import('../lib/config.js');
        log(`âœ“ config.js imported\n  - GOOGLE_CLIENT_ID: ${config.GOOGLE_CLIENT_ID?.substring(0, 20)}...\n  - getGoogleRedirectURI: ${typeof config.getGoogleRedirectURI}`, 'pass');

        const redirectUri = config.getGoogleRedirectURI();
        log(`âœ“ getGoogleRedirectURI() returns: ${redirectUri}`, 'pass');
      } catch (e) {
        log(`âœ— config.js import error: ${e.message}\n${e.stack}`, 'fail');
      }

      // 4. Test Google API client import
      try {
        const googleApi = await import('../lib/google-api-client.js');
        log(`âœ“ google-api-client.js imported\n  - getAccessToken: ${typeof googleApi.getAccessToken}`, 'pass');

        // Try to call getAccessToken
        const token = await googleApi.getAccessToken();
        log(`âœ“ getAccessToken() returned: ${token === null ? 'null (no token)' : 'token exists'}`, 'pass');
      } catch (e) {
        log(`âœ— google-api-client.js error: ${e.message}\n${e.stack}`, 'fail');
      }

      // 5. Test Supabase client import
      try {
        const supabase = await import('../lib/supabase-client.js');
        log(`âœ“ supabase-client.js imported\n  - supabase: ${typeof supabase.supabase}\n  - getSession: ${typeof supabase.getSession}`, 'pass');

        // Try to get session
        const session = await supabase.getSession();
        log(`âœ“ getSession() returned: ${JSON.stringify(session)}`, 'pass');
      } catch (e) {
        log(`âœ— supabase-client.js error: ${e.message}\n${e.stack}`, 'fail');
      }

      // 6. Check if we're in dist or source
      try {
        const url = window.location.href;
        const isInDist = url.includes('/dist/');
        log(`${isInDist ? 'âœ“' : 'âœ—'} Location: ${url}\n  Running from ${isInDist ? 'dist/' : 'source/'} folder`, isInDist ? 'pass' : 'fail');
      } catch (e) {
        log(`âœ— Location check error: ${e.message}`, 'fail');
      }

      // 7. Check manifest
      try {
        const manifest = chrome.runtime.getManifest();
        log(`âœ“ Manifest loaded\n  - version: ${manifest.version}\n  - background: ${manifest.background?.service_worker}`, 'pass');
      } catch (e) {
        log(`âœ— Manifest error: ${e.message}`, 'fail');
      }

      log('âœ… Diagnostics complete', 'info');
    }

    runDiagnostics().catch(err => {
      log(`Fatal error: ${err.message}\n${err.stack}`, 'fail');
    });
  </script>
</body>
</html>
