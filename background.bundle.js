var M="dailyScrumBuffer";var h="captures";var I=class{constructor(){this.db=null}async _initDB(){return this.db?this.db:new Promise((o,e)=>{let t=indexedDB.open(M,1);t.onerror=()=>{console.error("[TempBuffer] IndexedDB open error:",t.error),e(t.error)},t.onsuccess=()=>{this.db=t.result,o(this.db)},t.onupgradeneeded=n=>{let a=n.target.result;a.objectStoreNames.contains(h)||a.createObjectStore(h,{keyPath:"id",autoIncrement:!0}).createIndex("timestamp","timestamp",{unique:!1})},t.onblocked=()=>{console.warn("[TempBuffer] IndexedDB blocked by another connection"),e(new Error("IndexedDB blocked"))}})}async add(o){try{let t=(await this._initDB()).transaction([h],"readwrite"),n=t.objectStore(h),a={...o,timestamp:Date.now()};return new Promise((c,i)=>{let l=n.add(a);l.onsuccess=()=>{c(l.result)},l.onerror=()=>{console.error("[TempBuffer] Add error:",l.error),i(l.error)},t.oncomplete=()=>{},t.onerror=()=>{console.error("[TempBuffer] Add transaction error:",t.error),i(t.error)}})}catch(e){throw console.error("[TempBuffer] add() error:",e),e}}async cleanup(){try{let e=(await this._initDB()).transaction([h],"readwrite"),n=e.objectStore(h).index("timestamp"),a=Date.now()-864e5,c=IDBKeyRange.upperBound(a);return new Promise((i,l)=>{let u=0,m=n.openCursor(c);m.onsuccess=w=>{let _=w.target.result;_&&(_.delete(),u++,_.continue())},m.onerror=()=>{console.error("[TempBuffer] Cleanup cursor error:",m.error),l(m.error)},e.oncomplete=()=>{u>0,i(u)},e.onerror=()=>{console.error("[TempBuffer] Cleanup transaction error:",e.error),l(e.error)}})}catch(o){throw console.error("[TempBuffer] cleanup() error:",o),o}}async flushToServer(o){try{let e=await this._initDB();await this.cleanup();let t=await this._getAllData(e);if(t.length===0)return 0;try{await o(t)}catch(n){throw console.error("[TempBuffer] encryptAndSend callback error:",n),n}return await this._clearAll(e),t.length}catch(e){throw console.error("[TempBuffer] flushToServer() error:",e),e}}async _getAllData(o){let t=o.transaction([h],"readonly").objectStore(h);return new Promise((n,a)=>{let c=t.getAll();c.onsuccess=()=>{n(c.result)},c.onerror=()=>{console.error("[TempBuffer] getAll error:",c.error),a(c.error)}})}async _clearAll(o){let e=o.transaction([h],"readwrite"),t=e.objectStore(h);return new Promise((n,a)=>{let c=t.clear();c.onsuccess=()=>{n()},c.onerror=()=>{console.error("[TempBuffer] clear error:",c.error),a(c.error)},e.oncomplete=()=>{n()},e.onerror=()=>{console.error("[TempBuffer] Clear transaction error:",e.error),a(e.error)}})}async getCount(){try{let t=(await this._initDB()).transaction([h],"readonly").objectStore(h);return new Promise((n,a)=>{let c=t.count();c.onsuccess=()=>{n(c.result)},c.onerror=()=>{console.error("[TempBuffer] count error:",c.error),a(c.error)}})}catch(o){return console.error("[TempBuffer] getCount() error:",o),0}}close(){this.db&&(this.db.close(),this.db=null)}},y=new I;var D=class r{#e=null;static#r=3e5;static#t=12;static#o=10*1024*1024;async deriveKey(o,e){if(!o||!e)throw new Error("userId and serverSalt are required");let t=new TextEncoder,n=await crypto.subtle.importKey("raw",t.encode(o),"PBKDF2",!1,["deriveKey"]);this.#e=await crypto.subtle.deriveKey({name:"PBKDF2",salt:t.encode(e),iterations:r.#r,hash:"SHA-256"},n,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"]),typeof process<"u"}async encrypt(o){if(!this.#e)throw new Error("Encryption key not derived. Call deriveKey() first.");try{let e=crypto.getRandomValues(new Uint8Array(r.#t)),t=JSON.stringify(o),n=new TextEncoder().encode(t),a=await crypto.subtle.encrypt({name:"AES-GCM",iv:e},this.#e,n);return{iv:Array.from(e),ciphertext:Array.from(new Uint8Array(a)),algorithm:"AES-GCM-256",timestamp:Date.now()}}catch{throw console.error("[Encryption] Encryption failed"),new Error("Encryption failed")}}async decrypt(o){if(!this.#e)throw new Error("Encryption key not derived. Call deriveKey() first.");try{if(!o.iv||!o.ciphertext)throw new Error("Invalid encrypted data format");if(o.iv.length!==r.#t)throw new Error("Invalid encrypted data format");if(o.ciphertext.length>r.#o)throw new Error("Invalid encrypted data format");let e=new Uint8Array(o.iv),t=new Uint8Array(o.ciphertext),n=await crypto.subtle.decrypt({name:"AES-GCM",iv:e},this.#e,t),a=new TextDecoder().decode(n);return JSON.parse(a)}catch{throw console.error("[Encryption] Decryption failed"),new Error("Decryption failed")}}hasKey(){return this.#e!==null}clearKey(){this.#e=null}},d=new D;var f="https://zoqtvrcrqnaatkdwmail.supabase.co",ce=import.meta.env?.VITE_API_URL||"https://api-production-890f.up.railway.app";var T="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpvcXR2cmNycW5hYXRrZHdtYWlsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0MDg5ODksImV4cCI6MjA4NDk4NDk4OX0.j2NNC57jmWPANjGufdLZb0FPz8lhOdaq9V32Fv0zZpE";var ie=import.meta.env?.VITE_GOOGLE_AUTH_CLIENT_ID||"167290902104-m31v1limo9qjec9s7f9r9k9ltu4n25b3.apps.googleusercontent.com";async function p(r=!0){return new Promise((o,e)=>{chrome.identity.getAuthToken({interactive:r},t=>{if(chrome.runtime.lastError)return console.error("[Google API] OAuth flow error:",chrome.runtime.lastError),e(new Error(chrome.runtime.lastError.message));if(!t)return e(new Error("No token received"));o(t)})})}async function b(){try{return await p(!1)}catch{return null}}async function A(){return await p(!0)}async function j(r){let o=await A(),e=await fetch(`https://docs.googleapis.com/v1/documents/${r}`,{headers:{Authorization:`Bearer ${o}`}});if(!e.ok){let t=await e.text();throw new Error(`Docs API error: ${e.status} - ${t}`)}return await e.json()}async function v(r){let o=await j(r),e="";if(o.body&&o.body.content){for(let t of o.body.content)if(t.paragraph)for(let n of t.paragraph.elements||[])n.textRun&&n.textRun.content&&(e+=n.textRun.content)}return e}async function k(r){let o=await A(),e=await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${r}`,{headers:{Authorization:`Bearer ${o}`}});if(!e.ok){let t=await e.text();throw new Error(`Sheets API error: ${e.status} - ${t}`)}return await e.json()}async function F(r){let o=await A(),e=await fetch(`https://slides.googleapis.com/v1/presentations/${r}`,{headers:{Authorization:`Bearer ${o}`}});if(!e.ok){let t=await e.text();throw new Error(`Slides API error: ${e.status} - ${t}`)}return await e.json()}async function x(r){let o=await F(r),e=[],t="";return o.slides&&o.slides.forEach((n,a)=>{let c="";if(n.pageElements){for(let i of n.pageElements)if(i.shape&&i.shape.text)for(let l of i.shape.text.textElements||[])l.textRun&&l.textRun.content&&(c+=l.textRun.content)}c.trim()&&(e.push({slideNumber:a+1,text:c.trim()}),t+=c+`
`)}),{slides:e,fullText:t.trim()}}chrome.runtime.onMessage.addListener((r,o,e)=>{if(r.action==="DATA_CAPTURED")G(r.payload,o),e({success:!0});else if(r.action==="TAB_TRANSITION")X(r.payload,o),e({success:!0});else{if(r.action==="GOOGLE_API_REQUEST")return V(r.payload).then(t=>e({success:!0,data:t})).catch(t=>e({success:!1,error:t.message})),!0;if(r.action==="AUTHORIZE_GOOGLE_WORKSPACE")return p().then(t=>e({success:!0,token:t})).catch(t=>e({success:!1,error:t.message})),!0;if(r.action==="START_COLLECTION")return Y().then(t=>e(t)).catch(t=>e({success:!1,error:t.message})),!0;if(r.action==="STOP_COLLECTION")return H().then(t=>e(t)).catch(t=>e({success:!1,error:t.message})),!0;if(r.action==="FORCE_FLUSH")return J().then(t=>e(t)).catch(t=>e({success:!1,error:t.message})),!0;if(r.action==="GET_COLLECTION_STATE")return W().then(t=>e(t)).catch(t=>e({success:!1,error:t.message})),!0;console.warn("[Daily Scrum] Unknown action:",r.action),e({success:!1,error:"Unknown action"})}return!0});var O=1,E=3,q=1e3,S=500,U=Promise.resolve();function N(){let r,o=U;return U=new Promise(e=>{r=e}),o.then(()=>r)}var s={CONSENT_GIVEN:"consentGiven",IS_LOGGED_IN:"isLoggedIn",USER_ID:"userId",SEND_QUEUE:"sendQueue",LAST_TRANSITION:"lastTransition",ACTIVE_TAB_INFO:"activeTabInfo",SERVER_SALT:"serverSalt",AUTH_TOKEN:"authToken",REFRESH_TOKEN:"refreshToken",IS_COLLECTING:"isCollecting",COLLECTION_START_TIME:"collectionStartTime",COLLECTION_STOP_TIME:"collectionStopTime",LAST_GENERATED_RANGE:"lastGeneratedRange",TODAY_COLLECTED_COUNT:"todayCollectedCount",TODAY_COLLECTED_DATE:"todayCollectedDate"},C=[{patterns:["https://chatgpt.com/*","https://chat.openai.com/*","https://claude.ai/*","https://gemini.google.com/*"],scripts:["content-scripts/llm-capture.js","content-scripts/interaction-tracker.js"]},{patterns:["https://www.notion.so/*","https://app.slack.com/*"],scripts:["content-scripts/collab-capture.js","content-scripts/interaction-tracker.js"]},{patterns:["https://docs.google.com/*","https://sheets.google.com/*","https://slides.google.com/*","https://drive.google.com/*"],scripts:["content-scripts/google-capture.js","content-scripts/interaction-tracker.js"]},{patterns:["https://developer.mozilla.org/*","https://stackoverflow.com/*","https://github.com/*","https://medium.com/*","https://dev.to/*"],scripts:["content-scripts/web-reference-tracker.js"]}],g=null;function K(){return g||(g=Q().finally(()=>{g=null}),g)}async function Q(){try{let r=await chrome.storage.local.get(["refreshToken"]);if(!r.refreshToken)return console.error("[Daily Scrum] \u274C No refresh token in storage"),null;console.log("[Daily Scrum] \u{1F504} Refreshing auth token...");let o=await fetch(`${f}/auth/v1/token?grant_type=refresh_token`,{method:"POST",headers:{"Content-Type":"application/json",apikey:T},body:JSON.stringify({refresh_token:r.refreshToken})});if(!o.ok){let t=await o.text();return console.error("[Daily Scrum] \u274C Token refresh failed:",t),(o.status===400||o.status===401)&&(console.log("[Daily Scrum] \u{1F512} Session expired, clearing auth state..."),await chrome.storage.local.set({isLoggedIn:!1,authToken:null,refreshToken:null})),null}let e=await o.json();return await chrome.storage.local.set({authToken:e.access_token,refreshToken:e.refresh_token,isLoggedIn:!0}),console.log("[Daily Scrum] \u2705 Auth token refreshed successfully"),e.access_token}catch(r){return console.error("[Daily Scrum] \u274C Token refresh error:",r),null}}chrome.runtime.onInstalled.addListener(async r=>{console.log("[Daily Scrum] Service Worker installed:",r.reason),chrome.alarms.create("batchSend",{periodInMinutes:O}),(await chrome.storage.local.get([s.CONSENT_GIVEN,s.IS_LOGGED_IN]))[s.IS_LOGGED_IN]===void 0&&await chrome.storage.local.set({[s.IS_LOGGED_IN]:!1,[s.SEND_QUEUE]:[]}),console.log("[Daily Scrum] Alarms configured: batchSend every",O,"minute(s)"),(r.reason==="install"||r.reason==="update")&&await z()});async function z(){console.log("[Daily Scrum] Injecting content scripts to existing tabs...");for(let r of C)try{if(!await chrome.permissions.contains({origins:r.patterns}))continue;let e=await chrome.tabs.query({url:r.patterns});for(let t of e)if(!(!t.id||t.id===chrome.tabs.TAB_ID_NONE))for(let n of r.scripts)try{await chrome.scripting.executeScript({target:{tabId:t.id},files:[n]}),console.log(`[Daily Scrum] Injected ${n} into tab ${t.id} (${t.url})`)}catch(a){console.log(`[Daily Scrum] Could not inject ${n} into tab ${t.id}:`,a.message)}}catch(o){console.error("[Daily Scrum] Tab query failed for patterns",r.patterns,":",o)}console.log("[Daily Scrum] Content script injection completed")}chrome.permissions.onAdded.addListener(async r=>{if(!r.origins||r.origins.length===0)return;console.log("[Daily Scrum] Permissions granted:",r.origins);let o=new Set(r.origins);for(let e of C){let t=e.patterns.filter(n=>o.has(n));if(t.length!==0)try{let n=await chrome.tabs.query({url:t});for(let a of n)if(!(!a.id||a.id===chrome.tabs.TAB_ID_NONE))for(let c of e.scripts)try{await chrome.scripting.executeScript({target:{tabId:a.id},files:[c]}),console.log(`[Daily Scrum] Injected ${c} into tab ${a.id} (${a.url})`)}catch(i){console.log(`[Daily Scrum] Could not inject ${c} into tab ${a.id}:`,i.message)}}catch(n){console.error("[Daily Scrum] Tab query failed for granted patterns:",n)}}});chrome.permissions.onRemoved.addListener(async r=>{if(!r.origins||r.origins.length===0)return;console.log("[Daily Scrum] Permissions revoked:",r.origins);let o=new Set(r.origins);for(let e of C){let t=e.patterns.filter(n=>o.has(n));if(t.length!==0)try{let n=await chrome.tabs.query({url:t});for(let a of n)!a.id||a.id===chrome.tabs.TAB_ID_NONE||chrome.tabs.sendMessage(a.id,{action:"CLEANUP_AND_STOP"}).catch(()=>{})}catch{}}});chrome.runtime.onStartup.addListener(async()=>{console.log("[Daily Scrum] Service Worker started"),await chrome.alarms.get("batchSend")||(chrome.alarms.create("batchSend",{periodInMinutes:O}),console.log("[Daily Scrum] batchSend alarm recreated on startup"));let o=await chrome.storage.local.get([s.IS_COLLECTING,s.COLLECTION_START_TIME]);if(o[s.IS_COLLECTING]&&o[s.COLLECTION_START_TIME]){let e=new Date().toLocaleDateString("ko-KR",{timeZone:"Asia/Seoul"}),t=new Date(o[s.COLLECTION_START_TIME]).toLocaleDateString("ko-KR",{timeZone:"Asia/Seoul"});t!==e&&(console.log("[Daily Scrum] Stale collection from",t,"\u2192 auto-stopping"),await chrome.storage.local.set({[s.IS_COLLECTING]:!1,[s.COLLECTION_STOP_TIME]:Date.now()}))}});async function V(r){try{let{apiType:o,documentId:e}=r,t=await b();switch(t||(t=await p()),o){case"docs":let n=await v(e);return{documentId:e,text:n,type:"docs"};case"sheets":let a=await k(e);return{documentId:e,title:a.properties?.title,sheets:a.sheets?.map(i=>i.properties?.title),type:"sheets"};case"slides":let c=await x(e);return{documentId:e,slides:c.slides,fullText:c.fullText,type:"slides"};default:throw new Error(`Unknown API type: ${o}`)}}catch(o){throw console.error("[Daily Scrum] Google API request error:",o),o}}async function Y(){let r=Date.now();return await chrome.storage.local.set({[s.IS_COLLECTING]:!0,[s.COLLECTION_START_TIME]:r,[s.COLLECTION_STOP_TIME]:null}),console.log("[Daily Scrum] \u25B6 Collection started at",new Date(r).toISOString()),{success:!0,startTime:r}}async function H(){let r=Date.now();return await chrome.storage.local.set({[s.IS_COLLECTING]:!1,[s.COLLECTION_STOP_TIME]:r}),console.log("[Daily Scrum] \u23F9 Collection stopped at",new Date(r).toISOString()),{success:!0,stopTime:r}}async function J(){console.log("[Daily Scrum] \u{1F504} Force flushing all tabs...");try{let o=(await chrome.tabs.query({})).map(e=>!e.id||e.id===chrome.tabs.TAB_ID_NONE?Promise.resolve():chrome.tabs.sendMessage(e.id,{action:"FLUSH_NOW"}).catch(()=>{}));return await Promise.all(o),console.log("[Daily Scrum] \u2705 FLUSH_NOW broadcast completed"),await new Promise(e=>setTimeout(e,2e3)),await $(),await B(),console.log("[Daily Scrum] \u2705 Force batch send completed"),{success:!0}}catch(r){return console.error("[Daily Scrum] \u274C Force flush failed:",r),{success:!1,error:r.message}}}async function W(){let r=await chrome.storage.local.get([s.IS_COLLECTING,s.COLLECTION_START_TIME,s.COLLECTION_STOP_TIME,s.LAST_GENERATED_RANGE,s.SEND_QUEUE]);return{success:!0,isCollecting:r[s.IS_COLLECTING]||!1,startTime:r[s.COLLECTION_START_TIME]||null,stopTime:r[s.COLLECTION_STOP_TIME]||null,lastGeneratedRange:r[s.LAST_GENERATED_RANGE]||null,queueLength:r[s.SEND_QUEUE]?.length||0}}async function G(r,o){let e=null;try{let{consentGiven:t,isCollecting:n}=await chrome.storage.local.get(["consentGiven","isCollecting"]);if(t!==!0||n!==!0)return;let{isLoggedIn:a}=await chrome.storage.local.get([s.IS_LOGGED_IN]);if(e={...r,tabId:o.tab?.id,capturedAt:Date.now()},r.source!=="interaction"&&(e.url=o.tab?.url),a){d.hasKey()||(console.warn("[Daily Scrum] Encryption key not derived, initializing..."),await L());let{source:c,type:i,...l}=e,u=await d.encrypt(l),m={source:c||i||"unknown",iv:JSON.stringify(u.iv),ciphertext:JSON.stringify(u.ciphertext),algorithm:u.algorithm,timestamp:u.timestamp,metadata:{}};await Z(m)}else await P(e)}catch(t){let n=e||r;if(n){console.warn("[Daily Scrum] handleDataCaptured error, saving to temp buffer:",t.message);try{await P(n)}catch(a){console.error("[Daily Scrum] Failed to save to temp buffer:",a)}}else console.error("[Daily Scrum] handleDataCaptured error:",t)}}async function Z(r){let o=await N();try{let{sendQueue:e=[]}=await chrome.storage.local.get([s.SEND_QUEUE]);if(e.push(r),e.length>S){let t=e.length-S;e.splice(0,t),console.warn(`[Daily Scrum] Queue overflow: dropped ${t} oldest items`)}await chrome.storage.local.set({[s.SEND_QUEUE]:e}),await R(1)}catch(e){if(e.message?.includes("QUOTA_BYTES")){console.warn("[Daily Scrum] Storage quota exceeded, evicting oldest 50%...");try{let{sendQueue:t=[]}=await chrome.storage.local.get([s.SEND_QUEUE]),n=t.slice(Math.ceil(t.length/2));n.push(r);try{await chrome.storage.local.set({[s.SEND_QUEUE]:n}),console.log(`[Daily Scrum] Evicted oldest 50%, kept ${n.length} items`)}catch(a){if(a.message?.includes("QUOTA_BYTES"))console.error("[Daily Scrum] Still over quota after 50% eviction, clearing queue"),await chrome.storage.local.set({[s.SEND_QUEUE]:[]});else throw a}}catch(t){console.error("[Daily Scrum] Eviction failed, clearing queue:",t),await chrome.storage.local.set({[s.SEND_QUEUE]:[]})}}else throw e}finally{o()}}async function R(r=1){let o=new Date().toLocaleDateString("ko-KR",{timeZone:"Asia/Seoul"}),e=await chrome.storage.local.get([s.TODAY_COLLECTED_COUNT,s.TODAY_COLLECTED_DATE]),t=e[s.TODAY_COLLECTED_COUNT]||0;e[s.TODAY_COLLECTED_DATE]!==o&&(t=0),await chrome.storage.local.set({[s.TODAY_COLLECTED_COUNT]:t+r,[s.TODAY_COLLECTED_DATE]:o})}async function P(r){try{await y.add(r)}catch(o){console.error("[Daily Scrum] addToTempBuffer error:",o)}}async function X(r,o){try{let{type:e,hostname:t,at:n}=r,a=o.tab?.id;if(e==="leave")await chrome.storage.local.set({[s.LAST_TRANSITION]:{type:"leave",hostname:t,at:n,tabId:a}});else if(e==="enter"){let{lastTransition:c}=await chrome.storage.local.get([s.LAST_TRANSITION]);if(c&&c.type==="leave"){let i={from:c.hostname,to:t,leftAt:c.at,enteredAt:n,gap:n-c.at,timestamp:n};await G({type:"DAILY_SCRUM_CAPTURE",source:"interaction",data:i},o),await chrome.storage.local.remove(s.LAST_TRANSITION)}}}catch(e){console.error("[Daily Scrum] handleTabTransition error:",e)}}chrome.tabs.onActivated.addListener(async r=>{try{let o=await chrome.tabs.get(r.tabId),e=new URL(o.url).hostname;await chrome.storage.local.set({[s.ACTIVE_TAB_INFO]:{tabId:r.tabId,hostname:e,activatedAt:Date.now()}})}catch{}});chrome.alarms.onAlarm.addListener(async r=>{r.name==="batchSend"&&await B()});async function B(){let r=await N();try{let{sendQueue:o=[],isLoggedIn:e}=await chrome.storage.local.get([s.SEND_QUEUE,s.IS_LOGGED_IN]);if(!e||o.length===0)return;await oe(o)?await chrome.storage.local.set({[s.SEND_QUEUE]:[],lastSyncTime:Date.now()}):console.error("[Daily Scrum] Batch send failed after retries")}catch(o){console.error("[Daily Scrum] processBatchSend error:",o)}finally{r()}}chrome.storage.onChanged.addListener(async(r,o)=>{if(o==="local"&&r[s.IS_LOGGED_IN]){let{newValue:e}=r[s.IS_LOGGED_IN];console.log("[Daily Scrum] Login state changed:",e),e===!0?(await L(),await $()):d.clearKey()}});async function $(){try{if(await y.getCount()===0)return;d.hasKey()||await L(),await y.flushToServer(async o=>{let e=await N();try{let{sendQueue:t=[]}=await chrome.storage.local.get([s.SEND_QUEUE]),n=[];for(let c of o)try{let{source:i,type:l,...u}=c,m=await d.encrypt(u),w={source:i||l||"unknown",iv:JSON.stringify(m.iv),ciphertext:JSON.stringify(m.ciphertext),algorithm:m.algorithm,timestamp:m.timestamp,metadata:{}};n.push(w)}catch(i){console.error("[Daily Scrum] Failed to encrypt temp buffer item:",i)}let a=[...t,...n];if(a.length>S){let c=a.length-S;a=a.slice(c),console.warn(`[Daily Scrum] Queue overflow on flush: dropped ${c} oldest items`)}await chrome.storage.local.set({[s.SEND_QUEUE]:a}),n.length>0&&await R(n.length)}finally{e()}})}catch(r){console.error("[Daily Scrum] flushTempBufferToQueue error:",r)}}async function pe(){let{isLoggedIn:r,userId:o}=await chrome.storage.local.get([s.IS_LOGGED_IN,s.USER_ID]);return{isLoggedIn:r||!1,userId:o||null}}async function ge(r,o=null){await chrome.storage.local.set({[s.IS_LOGGED_IN]:r,[s.USER_ID]:o})}async function L(){try{let{userId:r,serverSalt:o,authToken:e}=await chrome.storage.local.get([s.USER_ID,s.SERVER_SALT,s.AUTH_TOKEN]);if(!r)throw new Error("User ID not found in storage");let t=o,n=!1;if(!t){if(!e)throw new Error("Cannot initialize encryption without auth token");try{let a=await te(r,e);a?(t=a,await chrome.storage.local.set({[s.SERVER_SALT]:t}),console.log("[Daily Scrum] \u2705 Downloaded existing salt from server (multi-device sync)")):(t=await re(),n=!0,await chrome.storage.local.set({[s.SERVER_SALT]:t}),console.log("[Daily Scrum] \u2705 Generated new server salt (first login)"))}catch(a){throw console.error("[Daily Scrum] \u274C Failed to fetch salt from server:",a.message),chrome.notifications.create({type:"basic",iconUrl:"icons/icon-48.png",title:"Daily Scrum Connection Required",message:"Cannot verify encryption settings. Please check your internet connection and try again.",priority:2}),new Error("Cannot initialize encryption: server salt verification failed. This prevents data corruption.")}}if(await d.deriveKey(r,t),console.log("[Daily Scrum] \u2705 Encryption initialized"),n&&e)try{await ee(r,t,e),console.log("[Daily Scrum] \u2705 Salt saved to Supabase")}catch(a){throw console.error("[Daily Scrum] \u274C Failed to save salt to Supabase after retries:",a),chrome.notifications.create({type:"basic",iconUrl:"icons/icon-48.png",title:"Daily Scrum Setup Failed",message:"Cannot connect to server. Please check your internet connection and try logging in again.",priority:2}),d.clearKey(),await chrome.storage.local.remove(s.SERVER_SALT),new Error("Failed to save encryption salt - cannot proceed without server synchronization")}}catch(r){throw console.error("[Daily Scrum] \u274C Failed to initialize encryption:",r),r}}async function ee(r,o,e){for(let a=1;a<=3;a++)try{let c=await fetch(`${f}/rest/v1/user_encryption_salts`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`,apikey:T,Prefer:"resolution=ignore-duplicates"},body:JSON.stringify({user_id:r,salt:o})});if(c.ok||c.status===409)return;let i=await c.text();throw new Error(`HTTP ${c.status}: ${i}`)}catch(c){if(console.error(`[Daily Scrum] Salt save attempt ${a}/3 failed:`,c.message),a>=3)throw new Error(`Failed to save salt after 3 attempts: ${c.message}`);let i=1e3*Math.pow(2,a-1);console.log(`[Daily Scrum] Retrying in ${i}ms...`),await new Promise(l=>setTimeout(l,i))}}async function te(r,o){try{let e=await fetch(`${f}/rest/v1/user_encryption_salts?user_id=eq.${r}&select=salt`,{method:"GET",headers:{Authorization:`Bearer ${o}`,apikey:T}});if(!e.ok)throw new Error(`HTTP ${e.status}: ${await e.text()}`);let t=await e.json();return t&&t.length>0&&t[0].salt?t[0].salt:null}catch(e){throw console.error("[Daily Scrum] Failed to fetch salt from server:",e.message),e}}async function re(){return crypto.randomUUID()+crypto.randomUUID()}async function oe(r){let o=`${f}/functions/v1/data-ingestion`;for(let e=0;e<E;e++)try{let t=await chrome.storage.local.get(["authToken"]);if(!t.authToken)return console.error("[Daily Scrum] \u274C No auth token in storage"),!1;let n={items:r},a=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t.authToken}`},body:JSON.stringify(n)});if(!a.ok){let c=await a.text();if(console.error("[Daily Scrum] - Error response:",c),a.status===401){let i=await K();if(i){let l=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify(n)});if(l.ok)return!0;let u=await l.text();throw new Error(`HTTP ${l.status} after token refresh: ${u}`)}}throw new Error(`HTTP ${a.status}: ${c}`)}return!0}catch(t){if(console.error(`[Daily Scrum] Send attempt ${e+1}/${E} failed:`,t.message),e<E-1){let n=q*Math.pow(2,e);await ne(n)}}return console.error("[Daily Scrum] Failed to send data after",E,"attempts"),!1}function ne(r){return new Promise(o=>setTimeout(o,r))}export{pe as getLoginState,ge as setLoginState};
