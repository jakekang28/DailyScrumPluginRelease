var M="dailyScrumBuffer";var u="captures";var I=class{constructor(){this.db=null}async _initDB(){return this.db?this.db:this._initPromise?this._initPromise:(this._initPromise=new Promise((o,e)=>{let t=indexedDB.open(M,1);t.onerror=()=>{console.error("[TempBuffer] IndexedDB open error:",t.error),this._initPromise=null,e(t.error)},t.onsuccess=()=>{this.db=t.result,o(this.db)},t.onupgradeneeded=a=>{let n=a.target.result;n.objectStoreNames.contains(u)||n.createObjectStore(u,{keyPath:"id",autoIncrement:!0}).createIndex("timestamp","timestamp",{unique:!1})},t.onblocked=()=>{console.warn("[TempBuffer] IndexedDB blocked by another connection"),this._initPromise=null,e(new Error("IndexedDB blocked"))}}),this._initPromise)}async add(o){try{let t=(await this._initDB()).transaction([u],"readwrite"),a=t.objectStore(u),n={...o,timestamp:Date.now()};return new Promise((c,i)=>{let l=a.add(n);l.onsuccess=()=>{c(l.result)},l.onerror=()=>{console.error("[TempBuffer] Add error:",l.error),i(l.error)},t.oncomplete=()=>{},t.onerror=()=>{console.error("[TempBuffer] Add transaction error:",t.error),i(t.error)}})}catch(e){throw console.error("[TempBuffer] add() error:",e),e}}async cleanup(){try{let e=(await this._initDB()).transaction([u],"readwrite"),a=e.objectStore(u).index("timestamp"),n=Date.now()-864e5,c=IDBKeyRange.upperBound(n);return new Promise((i,l)=>{let h=0,m=a.openCursor(c);m.onsuccess=w=>{let _=w.target.result;_&&(_.delete(),h++,_.continue())},m.onerror=()=>{console.error("[TempBuffer] Cleanup cursor error:",m.error),l(m.error)},e.oncomplete=()=>{h>0,i(h)},e.onerror=()=>{console.error("[TempBuffer] Cleanup transaction error:",e.error),l(e.error)}})}catch(o){throw console.error("[TempBuffer] cleanup() error:",o),o}}async flushToServer(o){try{let e=await this._initDB();await this.cleanup();let t=await this._getAllData(e);if(t.length===0)return 0;try{await o(t)}catch(n){throw console.error("[TempBuffer] encryptAndSend callback error:",n),n}let a=t.map(n=>n.id).filter(n=>n!==void 0);return await this._deleteByIds(e,a),t.length}catch(e){throw console.error("[TempBuffer] flushToServer() error:",e),e}}async _getAllData(o){let t=o.transaction([u],"readonly").objectStore(u);return new Promise((a,n)=>{let c=t.getAll();c.onsuccess=()=>{a(c.result)},c.onerror=()=>{console.error("[TempBuffer] getAll error:",c.error),n(c.error)}})}async _clearAll(o){let e=o.transaction([u],"readwrite"),t=e.objectStore(u);return new Promise((a,n)=>{let c=t.clear();c.onsuccess=()=>{a()},c.onerror=()=>{console.error("[TempBuffer] clear error:",c.error),n(c.error)},e.oncomplete=()=>{a()},e.onerror=()=>{console.error("[TempBuffer] Clear transaction error:",e.error),n(e.error)}})}async _deleteByIds(o,e){if(e.length===0)return;let t=o.transaction([u],"readwrite"),a=t.objectStore(u);return new Promise((n,c)=>{for(let i of e)a.delete(i);t.oncomplete=()=>{n()},t.onerror=()=>{console.error("[TempBuffer] deleteByIds transaction error:",t.error),c(t.error)}})}async getCount(){try{let t=(await this._initDB()).transaction([u],"readonly").objectStore(u);return new Promise((a,n)=>{let c=t.count();c.onsuccess=()=>{a(c.result)},c.onerror=()=>{console.error("[TempBuffer] count error:",c.error),n(c.error)}})}catch(o){return console.error("[TempBuffer] getCount() error:",o),0}}close(){this.db&&(this.db.close(),this.db=null),this._initPromise=null}},y=new I;var D=class r{#e=null;static#r=3e5;static#t=12;static#o=10*1024*1024;async deriveKey(o,e){if(!o||!e)throw new Error("userId and serverSalt are required");let t=new TextEncoder,a=await crypto.subtle.importKey("raw",t.encode(o),"PBKDF2",!1,["deriveKey"]);this.#e=await crypto.subtle.deriveKey({name:"PBKDF2",salt:t.encode(e),iterations:r.#r,hash:"SHA-256"},a,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"]),typeof process<"u"}async encrypt(o){if(!this.#e)throw new Error("Encryption key not derived. Call deriveKey() first.");try{let e=crypto.getRandomValues(new Uint8Array(r.#t)),t=JSON.stringify(o),a=new TextEncoder().encode(t),n=await crypto.subtle.encrypt({name:"AES-GCM",iv:e},this.#e,a);return{iv:Array.from(e),ciphertext:Array.from(new Uint8Array(n)),algorithm:"AES-GCM-256",timestamp:Date.now()}}catch{throw console.error("[Encryption] Encryption failed"),new Error("Encryption failed")}}async decrypt(o){if(!this.#e)throw new Error("Encryption key not derived. Call deriveKey() first.");try{if(!o.iv||!o.ciphertext)throw new Error("Invalid encrypted data format");if(o.iv.length!==r.#t)throw new Error("Invalid encrypted data format");if(o.ciphertext.length>r.#o)throw new Error("Invalid encrypted data format");let e=new Uint8Array(o.iv),t=new Uint8Array(o.ciphertext),a=await crypto.subtle.decrypt({name:"AES-GCM",iv:e},this.#e,t),n=new TextDecoder().decode(a);return JSON.parse(n)}catch{throw console.error("[Encryption] Decryption failed"),new Error("Decryption failed")}}hasKey(){return this.#e!==null}clearKey(){this.#e=null}},d=new D;var f="https://zoqtvrcrqnaatkdwmail.supabase.co",ce=import.meta.env?.VITE_API_URL||"https://api-production-890f.up.railway.app";var T="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpvcXR2cmNycW5hYXRrZHdtYWlsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0MDg5ODksImV4cCI6MjA4NDk4NDk4OX0.j2NNC57jmWPANjGufdLZb0FPz8lhOdaq9V32Fv0zZpE";var ie=import.meta.env?.VITE_GOOGLE_AUTH_CLIENT_ID||"167290902104-m31v1limo9qjec9s7f9r9k9ltu4n25b3.apps.googleusercontent.com";async function p(r=!0){return new Promise((o,e)=>{chrome.identity.getAuthToken({interactive:r},t=>{if(chrome.runtime.lastError)return console.error("[Google API] OAuth flow error:",chrome.runtime.lastError),e(new Error(chrome.runtime.lastError.message));if(!t)return e(new Error("No token received"));o(t)})})}async function b(){try{return await p(!1)}catch{return null}}async function A(){return await p(!0)}async function j(r){let o=await A(),e=await fetch(`https://docs.googleapis.com/v1/documents/${r}`,{headers:{Authorization:`Bearer ${o}`}});if(!e.ok){let t=await e.text();throw new Error(`Docs API error: ${e.status} - ${t}`)}return await e.json()}async function v(r){let o=await j(r),e="";if(o.body&&o.body.content){for(let t of o.body.content)if(t.paragraph)for(let a of t.paragraph.elements||[])a.textRun&&a.textRun.content&&(e+=a.textRun.content)}return e}async function k(r){let o=await A(),e=await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${r}`,{headers:{Authorization:`Bearer ${o}`}});if(!e.ok){let t=await e.text();throw new Error(`Sheets API error: ${e.status} - ${t}`)}return await e.json()}async function F(r){let o=await A(),e=await fetch(`https://slides.googleapis.com/v1/presentations/${r}`,{headers:{Authorization:`Bearer ${o}`}});if(!e.ok){let t=await e.text();throw new Error(`Slides API error: ${e.status} - ${t}`)}return await e.json()}async function x(r){let o=await F(r),e=[],t="";return o.slides&&o.slides.forEach((a,n)=>{let c="";if(a.pageElements){for(let i of a.pageElements)if(i.shape&&i.shape.text)for(let l of i.shape.text.textElements||[])l.textRun&&l.textRun.content&&(c+=l.textRun.content)}c.trim()&&(e.push({slideNumber:n+1,text:c.trim()}),t+=c+`
`)}),{slides:e,fullText:t.trim()}}chrome.runtime.onMessage.addListener((r,o,e)=>{if(r.action==="DATA_CAPTURED")B(r.payload,o),e({success:!0});else if(r.action==="TAB_TRANSITION")X(r.payload,o),e({success:!0});else return r.action==="GOOGLE_API_REQUEST"?(V(r.payload).then(t=>e({success:!0,data:t})).catch(t=>e({success:!1,error:t.message})),!0):r.action==="AUTHORIZE_GOOGLE_WORKSPACE"?(p().then(t=>e({success:!0,token:t})).catch(t=>e({success:!1,error:t.message})),!0):r.action==="START_COLLECTION"?(Y().then(t=>e(t)).catch(t=>e({success:!1,error:t.message})),!0):r.action==="STOP_COLLECTION"?(H().then(t=>e(t)).catch(t=>e({success:!1,error:t.message})),!0):r.action==="FORCE_FLUSH"?(J().then(t=>e(t)).catch(t=>e({success:!1,error:t.message})),!0):r.action==="GET_COLLECTION_STATE"?(W().then(t=>e(t)).catch(t=>e({success:!1,error:t.message})),!0):(console.warn("[Daily Scrum] Unknown action:",r.action),e({success:!1,error:"Unknown action"}),!1)});var O=1,E=3,q=1e3,S=500,P=Promise.resolve();function N(){let r,o=P;return P=new Promise(e=>{r=e}),o.then(()=>r)}var s={CONSENT_GIVEN:"consentGiven",IS_LOGGED_IN:"isLoggedIn",USER_ID:"userId",SEND_QUEUE:"sendQueue",LAST_TRANSITION:"lastTransition",ACTIVE_TAB_INFO:"activeTabInfo",SERVER_SALT:"serverSalt",AUTH_TOKEN:"authToken",REFRESH_TOKEN:"refreshToken",IS_COLLECTING:"isCollecting",COLLECTION_START_TIME:"collectionStartTime",COLLECTION_STOP_TIME:"collectionStopTime",LAST_GENERATED_RANGE:"lastGeneratedRange",TODAY_COLLECTED_COUNT:"todayCollectedCount",TODAY_COLLECTED_DATE:"todayCollectedDate"},C=[{patterns:["https://chatgpt.com/*","https://chat.openai.com/*","https://claude.ai/*","https://gemini.google.com/*"],scripts:["content-scripts/llm-capture.js","content-scripts/interaction-tracker.js"]},{patterns:["https://www.notion.so/*","https://app.slack.com/*"],scripts:["content-scripts/collab-capture.js","content-scripts/interaction-tracker.js"]},{patterns:["https://docs.google.com/*","https://sheets.google.com/*","https://slides.google.com/*","https://drive.google.com/*"],scripts:["content-scripts/google-capture.js","content-scripts/interaction-tracker.js"]},{patterns:["https://developer.mozilla.org/*","https://stackoverflow.com/*","https://github.com/*","https://medium.com/*","https://dev.to/*"],scripts:["content-scripts/web-reference-tracker.js"]}],g=null;function K(){return g||(g=Q().finally(()=>{g=null}),g)}async function Q(){try{let r=await chrome.storage.local.get(["refreshToken"]);if(!r.refreshToken)return console.error("[Daily Scrum] \u274C No refresh token in storage"),null;console.log("[Daily Scrum] \u{1F504} Refreshing auth token...");let o=await fetch(`${f}/auth/v1/token?grant_type=refresh_token`,{method:"POST",headers:{"Content-Type":"application/json",apikey:T},body:JSON.stringify({refresh_token:r.refreshToken})});if(!o.ok){let t=await o.text();return console.error("[Daily Scrum] \u274C Token refresh failed:",t),(o.status===400||o.status===401)&&(console.log("[Daily Scrum] \u{1F512} Session expired, clearing auth state..."),await chrome.storage.local.set({isLoggedIn:!1,authToken:null,refreshToken:null})),null}let e=await o.json();return await chrome.storage.local.set({authToken:e.access_token,refreshToken:e.refresh_token,isLoggedIn:!0}),console.log("[Daily Scrum] \u2705 Auth token refreshed successfully"),e.access_token}catch(r){return console.error("[Daily Scrum] \u274C Token refresh error:",r),null}}chrome.runtime.onInstalled.addListener(async r=>{console.log("[Daily Scrum] Service Worker installed:",r.reason),chrome.alarms.create("batchSend",{periodInMinutes:O}),(await chrome.storage.local.get([s.CONSENT_GIVEN,s.IS_LOGGED_IN]))[s.IS_LOGGED_IN]===void 0&&await chrome.storage.local.set({[s.IS_LOGGED_IN]:!1,[s.SEND_QUEUE]:[]}),console.log("[Daily Scrum] Alarms configured: batchSend every",O,"minute(s)"),(r.reason==="install"||r.reason==="update")&&await z()});async function z(){console.log("[Daily Scrum] Injecting content scripts to existing tabs...");for(let r of C)try{if(!await chrome.permissions.contains({origins:r.patterns}))continue;let e=await chrome.tabs.query({url:r.patterns});for(let t of e)if(!(!t.id||t.id===chrome.tabs.TAB_ID_NONE))for(let a of r.scripts)try{await chrome.scripting.executeScript({target:{tabId:t.id},files:[a]}),console.log(`[Daily Scrum] Injected ${a} into tab ${t.id} (${t.url})`)}catch(n){console.log(`[Daily Scrum] Could not inject ${a} into tab ${t.id}:`,n.message)}}catch(o){console.error("[Daily Scrum] Tab query failed for patterns",r.patterns,":",o)}console.log("[Daily Scrum] Content script injection completed")}chrome.permissions.onAdded.addListener(async r=>{if(!r.origins||r.origins.length===0)return;console.log("[Daily Scrum] Permissions granted:",r.origins);let o=new Set(r.origins);for(let e of C){let t=e.patterns.filter(a=>o.has(a));if(t.length!==0)try{let a=await chrome.tabs.query({url:t});for(let n of a)if(!(!n.id||n.id===chrome.tabs.TAB_ID_NONE))for(let c of e.scripts)try{await chrome.scripting.executeScript({target:{tabId:n.id},files:[c]}),console.log(`[Daily Scrum] Injected ${c} into tab ${n.id} (${n.url})`)}catch(i){console.log(`[Daily Scrum] Could not inject ${c} into tab ${n.id}:`,i.message)}}catch(a){console.error("[Daily Scrum] Tab query failed for granted patterns:",a)}}});chrome.permissions.onRemoved.addListener(async r=>{if(!r.origins||r.origins.length===0)return;console.log("[Daily Scrum] Permissions revoked:",r.origins);let o=new Set(r.origins);for(let e of C){let t=e.patterns.filter(a=>o.has(a));if(t.length!==0)try{let a=await chrome.tabs.query({url:t});for(let n of a)!n.id||n.id===chrome.tabs.TAB_ID_NONE||chrome.tabs.sendMessage(n.id,{action:"CLEANUP_AND_STOP"}).catch(()=>{})}catch{}}});chrome.runtime.onStartup.addListener(async()=>{console.log("[Daily Scrum] Service Worker started"),await chrome.alarms.get("batchSend")||(chrome.alarms.create("batchSend",{periodInMinutes:O}),console.log("[Daily Scrum] batchSend alarm recreated on startup"));let o=await chrome.storage.local.get([s.IS_COLLECTING,s.COLLECTION_START_TIME]);if(o[s.IS_COLLECTING]&&o[s.COLLECTION_START_TIME]){let e=new Date().toLocaleDateString("ko-KR",{timeZone:"Asia/Seoul"}),t=new Date(o[s.COLLECTION_START_TIME]).toLocaleDateString("ko-KR",{timeZone:"Asia/Seoul"});t!==e&&(console.log("[Daily Scrum] Stale collection from",t,"\u2192 auto-stopping"),await chrome.storage.local.set({[s.IS_COLLECTING]:!1,[s.COLLECTION_STOP_TIME]:Date.now()}))}});async function V(r){try{let{apiType:o,documentId:e}=r,t=await b();switch(t||(t=await p()),o){case"docs":let a=await v(e);return{documentId:e,text:a,type:"docs"};case"sheets":let n=await k(e);return{documentId:e,title:n.properties?.title,sheets:n.sheets?.map(i=>i.properties?.title),type:"sheets"};case"slides":let c=await x(e);return{documentId:e,slides:c.slides,fullText:c.fullText,type:"slides"};default:throw new Error(`Unknown API type: ${o}`)}}catch(o){throw console.error("[Daily Scrum] Google API request error:",o),o}}async function Y(){let r=Date.now();return await chrome.storage.local.set({[s.IS_COLLECTING]:!0,[s.COLLECTION_START_TIME]:r,[s.COLLECTION_STOP_TIME]:null}),console.log("[Daily Scrum] \u25B6 Collection started at",new Date(r).toISOString()),{success:!0,startTime:r}}async function H(){let r=Date.now();return await chrome.storage.local.set({[s.IS_COLLECTING]:!1,[s.COLLECTION_STOP_TIME]:r}),console.log("[Daily Scrum] \u23F9 Collection stopped at",new Date(r).toISOString()),{success:!0,stopTime:r}}async function J(){console.log("[Daily Scrum] \u{1F504} Force flushing all tabs...");try{let o=(await chrome.tabs.query({})).map(e=>!e.id||e.id===chrome.tabs.TAB_ID_NONE?Promise.resolve():chrome.tabs.sendMessage(e.id,{action:"FLUSH_NOW"}).catch(()=>{}));return await Promise.all(o),console.log("[Daily Scrum] \u2705 FLUSH_NOW broadcast completed"),await new Promise(e=>setTimeout(e,2e3)),await $(),await R(),console.log("[Daily Scrum] \u2705 Force batch send completed"),{success:!0}}catch(r){return console.error("[Daily Scrum] \u274C Force flush failed:",r),{success:!1,error:r.message}}}async function W(){let r=await chrome.storage.local.get([s.IS_COLLECTING,s.COLLECTION_START_TIME,s.COLLECTION_STOP_TIME,s.LAST_GENERATED_RANGE,s.SEND_QUEUE]);return{success:!0,isCollecting:r[s.IS_COLLECTING]||!1,startTime:r[s.COLLECTION_START_TIME]||null,stopTime:r[s.COLLECTION_STOP_TIME]||null,lastGeneratedRange:r[s.LAST_GENERATED_RANGE]||null,queueLength:r[s.SEND_QUEUE]?.length||0}}async function B(r,o){let e=null;try{let{consentGiven:t,isCollecting:a}=await chrome.storage.local.get(["consentGiven","isCollecting"]);if(t!==!0||a!==!0)return;let{isLoggedIn:n}=await chrome.storage.local.get([s.IS_LOGGED_IN]);if(e={...r,tabId:o.tab?.id,capturedAt:Date.now()},r.source!=="interaction"&&(e.url=o.tab?.url),n){d.hasKey()||(console.warn("[Daily Scrum] Encryption key not derived, initializing..."),await L());let{source:c,type:i,...l}=e,h=await d.encrypt(l),m={source:c||i||"unknown",iv:JSON.stringify(h.iv),ciphertext:JSON.stringify(h.ciphertext),algorithm:h.algorithm,timestamp:h.timestamp,metadata:{}};await Z(m)}else await U(e)}catch(t){let a=e||r;if(a){console.warn("[Daily Scrum] handleDataCaptured error, saving to temp buffer:",t.message);try{await U(a)}catch(n){console.error("[Daily Scrum] Failed to save to temp buffer:",n)}}else console.error("[Daily Scrum] handleDataCaptured error:",t)}}async function Z(r){let o=await N();try{let{sendQueue:e=[]}=await chrome.storage.local.get([s.SEND_QUEUE]);if(e.push(r),e.length>S){let t=e.length-S;e.splice(0,t),console.warn(`[Daily Scrum] Queue overflow: dropped ${t} oldest items`)}await chrome.storage.local.set({[s.SEND_QUEUE]:e}),await G(1)}catch(e){if(e.message?.includes("QUOTA_BYTES")){console.warn("[Daily Scrum] Storage quota exceeded, evicting oldest 50%...");try{let{sendQueue:t=[]}=await chrome.storage.local.get([s.SEND_QUEUE]),a=t.slice(Math.ceil(t.length/2));a.push(r);try{await chrome.storage.local.set({[s.SEND_QUEUE]:a}),console.log(`[Daily Scrum] Evicted oldest 50%, kept ${a.length} items`)}catch(n){if(n.message?.includes("QUOTA_BYTES"))console.error("[Daily Scrum] Still over quota after 50% eviction, clearing queue"),await chrome.storage.local.set({[s.SEND_QUEUE]:[]});else throw n}}catch(t){console.error("[Daily Scrum] Eviction failed, clearing queue:",t),await chrome.storage.local.set({[s.SEND_QUEUE]:[]})}}else throw e}finally{o()}}async function G(r=1){let o=new Date().toLocaleDateString("ko-KR",{timeZone:"Asia/Seoul"}),e=await chrome.storage.local.get([s.TODAY_COLLECTED_COUNT,s.TODAY_COLLECTED_DATE]),t=e[s.TODAY_COLLECTED_COUNT]||0;e[s.TODAY_COLLECTED_DATE]!==o&&(t=0),await chrome.storage.local.set({[s.TODAY_COLLECTED_COUNT]:t+r,[s.TODAY_COLLECTED_DATE]:o})}async function U(r){try{await y.add(r)}catch(o){console.error("[Daily Scrum] addToTempBuffer error:",o)}}async function X(r,o){try{let{type:e,hostname:t,at:a}=r,n=o.tab?.id;if(e==="leave")await chrome.storage.local.set({[s.LAST_TRANSITION]:{type:"leave",hostname:t,at:a,tabId:n}});else if(e==="enter"){let{lastTransition:c}=await chrome.storage.local.get([s.LAST_TRANSITION]);if(c&&c.type==="leave"){let i={from:c.hostname,to:t,leftAt:c.at,enteredAt:a,gap:a-c.at,timestamp:a};await B({type:"DAILY_SCRUM_CAPTURE",source:"interaction",data:i},o),await chrome.storage.local.remove(s.LAST_TRANSITION)}}}catch(e){console.error("[Daily Scrum] handleTabTransition error:",e)}}chrome.tabs.onActivated.addListener(async r=>{try{let o=await chrome.tabs.get(r.tabId);if(!o.url)return;let e=new URL(o.url).hostname;await chrome.storage.local.set({[s.ACTIVE_TAB_INFO]:{tabId:r.tabId,hostname:e,activatedAt:Date.now()}})}catch{}});chrome.alarms.onAlarm.addListener(async r=>{r.name==="batchSend"&&await R()});async function R(){let r=await N();try{let{sendQueue:o=[],isLoggedIn:e}=await chrome.storage.local.get([s.SEND_QUEUE,s.IS_LOGGED_IN]);if(!e||o.length===0)return;await oe(o)?await chrome.storage.local.set({[s.SEND_QUEUE]:[],lastSyncTime:Date.now()}):console.error("[Daily Scrum] Batch send failed after retries")}catch(o){console.error("[Daily Scrum] processBatchSend error:",o)}finally{r()}}chrome.storage.onChanged.addListener(async(r,o)=>{if(o==="local"&&r[s.IS_LOGGED_IN]){let{newValue:e}=r[s.IS_LOGGED_IN];if(console.log("[Daily Scrum] Login state changed:",e),e===!0)try{await L(),await $()}catch(t){console.error("[Daily Scrum] Post-login init failed:",t)}else d.clearKey()}});async function $(){try{if(await y.getCount()===0)return;d.hasKey()||await L(),await y.flushToServer(async o=>{let e=await N();try{let{sendQueue:t=[]}=await chrome.storage.local.get([s.SEND_QUEUE]),a=[];for(let c of o)try{let{source:i,type:l,...h}=c,m=await d.encrypt(h),w={source:i||l||"unknown",iv:JSON.stringify(m.iv),ciphertext:JSON.stringify(m.ciphertext),algorithm:m.algorithm,timestamp:m.timestamp,metadata:{}};a.push(w)}catch(i){console.error("[Daily Scrum] Failed to encrypt temp buffer item:",i)}let n=[...t,...a];if(n.length>S){let c=n.length-S;n=n.slice(c),console.warn(`[Daily Scrum] Queue overflow on flush: dropped ${c} oldest items`)}await chrome.storage.local.set({[s.SEND_QUEUE]:n}),a.length>0&&await G(a.length)}finally{e()}})}catch(r){console.error("[Daily Scrum] flushTempBufferToQueue error:",r)}}async function pe(){let{isLoggedIn:r,userId:o}=await chrome.storage.local.get([s.IS_LOGGED_IN,s.USER_ID]);return{isLoggedIn:r||!1,userId:o||null}}async function ge(r,o=null){await chrome.storage.local.set({[s.IS_LOGGED_IN]:r,[s.USER_ID]:o})}async function L(){try{let{userId:r,serverSalt:o,authToken:e}=await chrome.storage.local.get([s.USER_ID,s.SERVER_SALT,s.AUTH_TOKEN]);if(!r)throw new Error("User ID not found in storage");let t=o,a=!1;if(!t){if(!e)throw new Error("Cannot initialize encryption without auth token");try{let n=await te(r,e);n?(t=n,await chrome.storage.local.set({[s.SERVER_SALT]:t}),console.log("[Daily Scrum] \u2705 Downloaded existing salt from server (multi-device sync)")):(t=await re(),a=!0,await chrome.storage.local.set({[s.SERVER_SALT]:t}),console.log("[Daily Scrum] \u2705 Generated new server salt (first login)"))}catch(n){throw console.error("[Daily Scrum] \u274C Failed to fetch salt from server:",n.message),chrome.notifications.create({type:"basic",iconUrl:"icons/icon-48.png",title:"Daily Scrum Connection Required",message:"Cannot verify encryption settings. Please check your internet connection and try again.",priority:2}),new Error("Cannot initialize encryption: server salt verification failed. This prevents data corruption.")}}if(await d.deriveKey(r,t),console.log("[Daily Scrum] \u2705 Encryption initialized"),a&&e)try{await ee(r,t,e),console.log("[Daily Scrum] \u2705 Salt saved to Supabase")}catch(n){throw console.error("[Daily Scrum] \u274C Failed to save salt to Supabase after retries:",n),chrome.notifications.create({type:"basic",iconUrl:"icons/icon-48.png",title:"Daily Scrum Setup Failed",message:"Cannot connect to server. Please check your internet connection and try logging in again.",priority:2}),d.clearKey(),await chrome.storage.local.remove(s.SERVER_SALT),new Error("Failed to save encryption salt - cannot proceed without server synchronization")}}catch(r){throw console.error("[Daily Scrum] \u274C Failed to initialize encryption:",r),r}}async function ee(r,o,e){for(let n=1;n<=3;n++)try{let c=await fetch(`${f}/rest/v1/user_encryption_salts`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`,apikey:T,Prefer:"resolution=ignore-duplicates"},body:JSON.stringify({user_id:r,salt:o})});if(c.ok||c.status===409)return;let i=await c.text();throw new Error(`HTTP ${c.status}: ${i}`)}catch(c){if(console.error(`[Daily Scrum] Salt save attempt ${n}/3 failed:`,c.message),n>=3)throw new Error(`Failed to save salt after 3 attempts: ${c.message}`);let i=1e3*Math.pow(2,n-1);console.log(`[Daily Scrum] Retrying in ${i}ms...`),await new Promise(l=>setTimeout(l,i))}}async function te(r,o){try{let e=await fetch(`${f}/rest/v1/user_encryption_salts?user_id=eq.${r}&select=salt`,{method:"GET",headers:{Authorization:`Bearer ${o}`,apikey:T}});if(!e.ok)throw new Error(`HTTP ${e.status}: ${await e.text()}`);let t=await e.json();return t&&t.length>0&&t[0].salt?t[0].salt:null}catch(e){throw console.error("[Daily Scrum] Failed to fetch salt from server:",e.message),e}}async function re(){return crypto.randomUUID()+crypto.randomUUID()}async function oe(r){let o=`${f}/functions/v1/data-ingestion`;for(let e=0;e<E;e++)try{let t=await chrome.storage.local.get(["authToken"]);if(!t.authToken)return console.error("[Daily Scrum] \u274C No auth token in storage"),!1;let a={items:r},n=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t.authToken}`},body:JSON.stringify(a)});if(!n.ok){let c=await n.text();if(console.error("[Daily Scrum] - Error response:",c),n.status===401){let i=await K();if(i){let l=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify(a)});if(l.ok)return!0;let h=await l.text();throw new Error(`HTTP ${l.status} after token refresh: ${h}`)}}throw new Error(`HTTP ${n.status}: ${c}`)}return!0}catch(t){if(console.error(`[Daily Scrum] Send attempt ${e+1}/${E} failed:`,t.message),e<E-1){let a=q*Math.pow(2,e);await ne(a)}}return console.error("[Daily Scrum] Failed to send data after",E,"attempts"),!1}function ne(r){return new Promise(o=>setTimeout(o,r))}export{pe as getLoginState,ge as setLoginState};
