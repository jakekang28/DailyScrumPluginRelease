var x="dailyScrumBuffer";var h="captures";var S=class{constructor(){this.db=null}async _initDB(){return this.db?this.db:new Promise((o,e)=>{let r=indexedDB.open(x,1);r.onerror=()=>{console.error("[TempBuffer] IndexedDB open error:",r.error),e(r.error)},r.onsuccess=()=>{this.db=r.result,o(this.db)},r.onupgradeneeded=a=>{let s=a.target.result;s.objectStoreNames.contains(h)||s.createObjectStore(h,{keyPath:"id",autoIncrement:!0}).createIndex("timestamp","timestamp",{unique:!1})},r.onblocked=()=>{console.warn("[TempBuffer] IndexedDB blocked by another connection"),e(new Error("IndexedDB blocked"))}})}async add(o){try{await this.cleanup();let r=(await this._initDB()).transaction([h],"readwrite"),a=r.objectStore(h),s={...o,timestamp:Date.now()};return new Promise((n,i)=>{let l=a.add(s);l.onsuccess=()=>{n(l.result)},l.onerror=()=>{console.error("[TempBuffer] Add error:",l.error),i(l.error)},r.oncomplete=()=>{},r.onerror=()=>{console.error("[TempBuffer] Add transaction error:",r.error),i(r.error)}})}catch(e){throw console.error("[TempBuffer] add() error:",e),e}}async cleanup(){try{let e=(await this._initDB()).transaction([h],"readwrite"),a=e.objectStore(h).index("timestamp"),s=Date.now()-18e5,n=IDBKeyRange.upperBound(s);return new Promise((i,l)=>{let u=0,m=a.openCursor(n);m.onsuccess=k=>{let T=k.target.result;T&&(T.delete(),u++,T.continue())},m.onerror=()=>{console.error("[TempBuffer] Cleanup cursor error:",m.error),l(m.error)},e.oncomplete=()=>{u>0,i(u)},e.onerror=()=>{console.error("[TempBuffer] Cleanup transaction error:",e.error),l(e.error)}})}catch(o){throw console.error("[TempBuffer] cleanup() error:",o),o}}async flushToServer(o){try{let e=await this._initDB(),r=await this._getAllData(e);if(r.length===0)return 0;try{await o(r)}catch(a){throw console.error("[TempBuffer] encryptAndSend callback error:",a),a}return await this._clearAll(e),r.length}catch(e){throw console.error("[TempBuffer] flushToServer() error:",e),e}}async _getAllData(o){let r=o.transaction([h],"readonly").objectStore(h);return new Promise((a,s)=>{let n=r.getAll();n.onsuccess=()=>{a(n.result)},n.onerror=()=>{console.error("[TempBuffer] getAll error:",n.error),s(n.error)}})}async _clearAll(o){let e=o.transaction([h],"readwrite"),r=e.objectStore(h);return new Promise((a,s)=>{let n=r.clear();n.onsuccess=()=>{a()},n.onerror=()=>{console.error("[TempBuffer] clear error:",n.error),s(n.error)},e.oncomplete=()=>{a()},e.onerror=()=>{console.error("[TempBuffer] Clear transaction error:",e.error),s(e.error)}})}async getCount(){try{let r=(await this._initDB()).transaction([h],"readonly").objectStore(h);return new Promise((a,s)=>{let n=r.count();n.onsuccess=()=>{a(n.result)},n.onerror=()=>{console.error("[TempBuffer] count error:",n.error),s(n.error)}})}catch(o){return console.error("[TempBuffer] getCount() error:",o),0}}close(){this.db&&(this.db.close(),this.db=null)}},y=new S;var E=class t{#e=null;static#r=3e5;static#t=12;static#o=10*1024*1024;async deriveKey(o,e){if(!o||!e)throw new Error("userId and serverSalt are required");let r=new TextEncoder,a=await crypto.subtle.importKey("raw",r.encode(o),"PBKDF2",!1,["deriveKey"]);this.#e=await crypto.subtle.deriveKey({name:"PBKDF2",salt:r.encode(e),iterations:t.#r,hash:"SHA-256"},a,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"]),typeof process<"u"}async encrypt(o){if(!this.#e)throw new Error("Encryption key not derived. Call deriveKey() first.");try{let e=crypto.getRandomValues(new Uint8Array(t.#t)),r=JSON.stringify(o),a=new TextEncoder().encode(r),s=await crypto.subtle.encrypt({name:"AES-GCM",iv:e},this.#e,a);return{iv:Array.from(e),ciphertext:Array.from(new Uint8Array(s)),algorithm:"AES-GCM-256",timestamp:Date.now()}}catch{throw console.error("[Encryption] Encryption failed"),new Error("Encryption failed")}}async decrypt(o){if(!this.#e)throw new Error("Encryption key not derived. Call deriveKey() first.");try{if(!o.iv||!o.ciphertext)throw new Error("Invalid encrypted data format");if(o.iv.length!==t.#t)throw new Error("Invalid encrypted data format");if(o.ciphertext.length>t.#o)throw new Error("Invalid encrypted data format");let e=new Uint8Array(o.iv),r=new Uint8Array(o.ciphertext),a=await crypto.subtle.decrypt({name:"AES-GCM",iv:e},this.#e,r),s=new TextDecoder().decode(a);return JSON.parse(s)}catch{throw console.error("[Encryption] Decryption failed"),new Error("Decryption failed")}}hasKey(){return this.#e!==null}clearKey(){this.#e=null}},p=new E;var f="https://zoqtvrcrqnaatkdwmail.supabase.co",g="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpvcXR2cmNycW5hYXRrZHdtYWlsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0MDg5ODksImV4cCI6MjA4NDk4NDk4OX0.j2NNC57jmWPANjGufdLZb0FPz8lhOdaq9V32Fv0zZpE";var te=import.meta.env?.VITE_GOOGLE_AUTH_CLIENT_ID||"167290902104-m31v1limo9qjec9s7f9r9k9ltu4n25b3.apps.googleusercontent.com";async function d(t=!0){return new Promise((o,e)=>{chrome.identity.getAuthToken({interactive:t},r=>{if(chrome.runtime.lastError)return console.error("[Google API] OAuth flow error:",chrome.runtime.lastError),e(new Error(chrome.runtime.lastError.message));if(!r)return e(new Error("No token received"));o(r)})})}async function A(){try{return await d(!1)}catch{return null}}async function I(){return await d(!0)}async function v(t){let o=await I(),e=await fetch(`https://docs.googleapis.com/v1/documents/${t}`,{headers:{Authorization:`Bearer ${o}`}});if(!e.ok){let r=await e.text();throw new Error(`Docs API error: ${e.status} - ${r}`)}return await e.json()}async function D(t){let o=await v(t),e="";if(o.body&&o.body.content){for(let r of o.body.content)if(r.paragraph)for(let a of r.paragraph.elements||[])a.textRun&&a.textRun.content&&(e+=a.textRun.content)}return e}async function N(t){let o=await I(),e=await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${t}`,{headers:{Authorization:`Bearer ${o}`}});if(!e.ok){let r=await e.text();throw new Error(`Sheets API error: ${e.status} - ${r}`)}return await e.json()}async function G(t){let o=await I(),e=await fetch(`https://slides.googleapis.com/v1/presentations/${t}`,{headers:{Authorization:`Bearer ${o}`}});if(!e.ok){let r=await e.text();throw new Error(`Slides API error: ${e.status} - ${r}`)}return await e.json()}async function O(t){let o=await G(t),e=[],r="";return o.slides&&o.slides.forEach((a,s)=>{let n="";if(a.pageElements){for(let i of a.pageElements)if(i.shape&&i.shape.text)for(let l of i.shape.text.textElements||[])l.textRun&&l.textRun.content&&(n+=l.textRun.content)}n.trim()&&(e.push({slideNumber:s+1,text:n.trim()}),r+=n+`
`)}),{slides:e,fullText:r.trim()}}var C=1,w=3,B=1e3,c={CONSENT_GIVEN:"consentGiven",IS_LOGGED_IN:"isLoggedIn",USER_ID:"userId",SEND_QUEUE:"sendQueue",LAST_TRANSITION:"lastTransition",ACTIVE_TAB_INFO:"activeTabInfo",SERVER_SALT:"serverSalt",AUTH_TOKEN:"authToken",REFRESH_TOKEN:"refreshToken",IS_COLLECTING:"isCollecting",COLLECTION_START_TIME:"collectionStartTime",COLLECTION_STOP_TIME:"collectionStopTime",LAST_GENERATED_RANGE:"lastGeneratedRange"},P=[{patterns:["https://chatgpt.com/*","https://chat.openai.com/*","https://claude.ai/*","https://gemini.google.com/*"],scripts:["content-scripts/llm-capture.js","content-scripts/interaction-tracker.js"]},{patterns:["https://www.notion.so/*","https://app.slack.com/*"],scripts:["content-scripts/collab-capture.js","content-scripts/interaction-tracker.js"]},{patterns:["https://docs.google.com/*","https://sheets.google.com/*","https://slides.google.com/*","https://drive.google.com/*"],scripts:["content-scripts/google-capture.js","content-scripts/interaction-tracker.js"]},{patterns:["https://developer.mozilla.org/*","https://stackoverflow.com/*","https://github.com/*","https://medium.com/*","https://dev.to/*"],scripts:["content-scripts/web-reference-tracker.js"]}];async function U(){try{let t=await chrome.storage.local.get(["refreshToken"]);if(!t.refreshToken)return console.error("[Daily Scrum] \u274C No refresh token in storage"),null;console.log("[Daily Scrum] \u{1F504} Refreshing auth token...");let o=await fetch(`${f}/auth/v1/token?grant_type=refresh_token`,{method:"POST",headers:{"Content-Type":"application/json",apikey:g},body:JSON.stringify({refresh_token:t.refreshToken})});if(!o.ok){let r=await o.text();return console.error("[Daily Scrum] \u274C Token refresh failed:",r),(o.status===400||o.status===401)&&(console.log("[Daily Scrum] \u{1F512} Session expired, clearing auth state..."),await chrome.storage.local.set({isLoggedIn:!1,authToken:null,refreshToken:null})),null}let e=await o.json();return await chrome.storage.local.set({authToken:e.access_token,refreshToken:e.refresh_token,isLoggedIn:!0}),console.log("[Daily Scrum] \u2705 Auth token refreshed successfully"),e.access_token}catch(t){return console.error("[Daily Scrum] \u274C Token refresh error:",t),null}}chrome.runtime.onInstalled.addListener(async t=>{console.log("[Daily Scrum] Service Worker installed:",t.reason),chrome.alarms.create("batchSend",{periodInMinutes:C}),(await chrome.storage.local.get([c.CONSENT_GIVEN,c.IS_LOGGED_IN]))[c.IS_LOGGED_IN]===void 0&&await chrome.storage.local.set({[c.IS_LOGGED_IN]:!1,[c.SEND_QUEUE]:[]}),console.log("[Daily Scrum] Alarms configured: batchSend every",C,"minute(s)"),(t.reason==="install"||t.reason==="update")&&await R()});async function R(){console.log("[Daily Scrum] Injecting content scripts to existing tabs...");for(let t of P)try{let o=await chrome.tabs.query({url:t.patterns});for(let e of o)if(!(!e.id||e.id===chrome.tabs.TAB_ID_NONE))for(let r of t.scripts)try{await chrome.scripting.executeScript({target:{tabId:e.id},files:[r]}),console.log(`[Daily Scrum] Injected ${r} into tab ${e.id} (${e.url})`)}catch(a){console.log(`[Daily Scrum] Could not inject ${r} into tab ${e.id}:`,a.message)}}catch(o){console.error("[Daily Scrum] Tab query failed for patterns",t.patterns,":",o)}console.log("[Daily Scrum] Content script injection completed")}chrome.runtime.onStartup.addListener(()=>{console.log("[Daily Scrum] Service Worker started")});chrome.runtime.onMessage.addListener((t,o,e)=>{if(t.action==="DATA_CAPTURED")L(t.payload,o),e({success:!0});else if(t.action==="TAB_TRANSITION")q(t.payload,o),e({success:!0});else{if(t.action==="GOOGLE_API_REQUEST")return $(t.payload).then(r=>e({success:!0,data:r})).catch(r=>e({success:!1,error:r.message})),!0;if(t.action==="AUTHORIZE_GOOGLE_WORKSPACE")return d().then(r=>e({success:!0,token:r})).catch(r=>e({success:!1,error:r.message})),!0;if(t.action==="START_COLLECTION")return j().then(r=>e(r)).catch(r=>e({success:!1,error:r.message})),!0;if(t.action==="STOP_COLLECTION")return M().then(r=>e(r)).catch(r=>e({success:!1,error:r.message})),!0;if(t.action==="FORCE_FLUSH")return F().then(r=>e(r)).catch(r=>e({success:!1,error:r.message})),!0;if(t.action==="GET_COLLECTION_STATE")return z().then(r=>e(r)).catch(r=>e({success:!1,error:r.message})),!0;console.warn("[Daily Scrum] Unknown action:",t.action),e({success:!1,error:"Unknown action"})}return!0});async function $(t){try{let{apiType:o,documentId:e}=t,r=await A();switch(r||(r=await d()),o){case"docs":let a=await D(e);return{documentId:e,text:a,type:"docs"};case"sheets":let s=await N(e);return{documentId:e,title:s.properties?.title,sheets:s.sheets?.map(i=>i.properties?.title),type:"sheets"};case"slides":let n=await O(e);return{documentId:e,slides:n.slides,fullText:n.fullText,type:"slides"};default:throw new Error(`Unknown API type: ${o}`)}}catch(o){throw console.error("[Daily Scrum] Google API request error:",o),o}}async function j(){let t=Date.now();return await chrome.storage.local.set({[c.IS_COLLECTING]:!0,[c.COLLECTION_START_TIME]:t,[c.COLLECTION_STOP_TIME]:null}),console.log("[Daily Scrum] \u25B6 Collection started at",new Date(t).toISOString()),{success:!0,startTime:t}}async function M(){let t=Date.now();return await chrome.storage.local.set({[c.IS_COLLECTING]:!1,[c.COLLECTION_STOP_TIME]:t}),console.log("[Daily Scrum] \u23F9 Collection stopped at",new Date(t).toISOString()),{success:!0,stopTime:t}}async function F(){console.log("[Daily Scrum] \u{1F504} Force flushing all tabs...");try{let o=(await chrome.tabs.query({})).map(e=>!e.id||e.id===chrome.tabs.TAB_ID_NONE?Promise.resolve():chrome.tabs.sendMessage(e.id,{action:"FLUSH_NOW"}).catch(()=>{}));return await Promise.all(o),console.log("[Daily Scrum] \u2705 FLUSH_NOW broadcast completed"),await new Promise(e=>setTimeout(e,500)),await b(),console.log("[Daily Scrum] \u2705 Force batch send completed"),{success:!0}}catch(t){return console.error("[Daily Scrum] \u274C Force flush failed:",t),{success:!1,error:t.message}}}async function z(){let t=await chrome.storage.local.get([c.IS_COLLECTING,c.COLLECTION_START_TIME,c.COLLECTION_STOP_TIME,c.LAST_GENERATED_RANGE,c.SEND_QUEUE]);return{success:!0,isCollecting:t[c.IS_COLLECTING]||!1,startTime:t[c.COLLECTION_START_TIME]||null,stopTime:t[c.COLLECTION_STOP_TIME]||null,lastGeneratedRange:t[c.LAST_GENERATED_RANGE]||null,queueLength:t[c.SEND_QUEUE]?.length||0}}async function L(t,o){try{let{consentGiven:e,isCollecting:r}=await chrome.storage.local.get(["consentGiven","isCollecting"]);if(e!==!0||r!==!0)return;let{isLoggedIn:a}=await chrome.storage.local.get([c.IS_LOGGED_IN]),s={...t,tabId:o.tab?.id,capturedAt:Date.now()};if(t.source!=="interaction"&&(s.url=o.tab?.url),a){p.hasKey()||(console.warn("[Daily Scrum] Encryption key not derived, initializing..."),await _());let{source:n,type:i,...l}=s,u=await p.encrypt(l),m={source:n||i||"unknown",iv:JSON.stringify(u.iv),ciphertext:JSON.stringify(u.ciphertext),algorithm:u.algorithm,timestamp:u.timestamp,metadata:{}};await K(m)}else await V(s)}catch(e){console.error("[Daily Scrum] handleDataCaptured error:",e)}}async function K(t){let{sendQueue:o=[]}=await chrome.storage.local.get([c.SEND_QUEUE]);o.push(t),await chrome.storage.local.set({[c.SEND_QUEUE]:o})}async function V(t){try{await y.add(t)}catch(o){console.error("[Daily Scrum] addToTempBuffer error:",o)}}async function q(t,o){try{let{type:e,hostname:r,at:a}=t,s=o.tab?.id;if(e==="leave")await chrome.storage.local.set({[c.LAST_TRANSITION]:{type:"leave",hostname:r,at:a,tabId:s}});else if(e==="enter"){let{lastTransition:n}=await chrome.storage.local.get([c.LAST_TRANSITION]);if(n&&n.type==="leave"){let i={from:n.hostname,to:r,leftAt:n.at,enteredAt:a,gap:a-n.at,timestamp:a};await L({type:"DAILY_SCRUM_CAPTURE",source:"interaction",data:i},o),await chrome.storage.local.remove(c.LAST_TRANSITION)}}}catch(e){console.error("[Daily Scrum] handleTabTransition error:",e)}}chrome.tabs.onActivated.addListener(async t=>{try{let o=await chrome.tabs.get(t.tabId),e=new URL(o.url).hostname;await chrome.storage.local.set({[c.ACTIVE_TAB_INFO]:{tabId:t.tabId,hostname:e,activatedAt:Date.now()}})}catch{}});chrome.alarms.onAlarm.addListener(async t=>{t.name==="batchSend"&&await b()});async function b(){try{let{sendQueue:t=[],isLoggedIn:o}=await chrome.storage.local.get([c.SEND_QUEUE,c.IS_LOGGED_IN]);if(!o||t.length===0)return;await Y(t)?await chrome.storage.local.set({[c.SEND_QUEUE]:[]}):console.error("[Daily Scrum] Batch send failed after retries")}catch(t){console.error("[Daily Scrum] processBatchSend error:",t)}}chrome.storage.onChanged.addListener(async(t,o)=>{if(o==="local"&&t[c.IS_LOGGED_IN]){let{newValue:e}=t[c.IS_LOGGED_IN];console.log("[Daily Scrum] Login state changed:",e),e===!0?(await _(),await Q()):p.clearKey()}});async function Q(){try{if(await y.getCount()===0)return;p.hasKey()||await _(),await y.flushToServer(async o=>{let{sendQueue:e=[]}=await chrome.storage.local.get([c.SEND_QUEUE]),r=[];for(let s of o)try{let{source:n,type:i,...l}=s,u=await p.encrypt(l),m={source:n||i||"unknown",iv:JSON.stringify(u.iv),ciphertext:JSON.stringify(u.ciphertext),algorithm:u.algorithm,timestamp:u.timestamp,metadata:{}};r.push(m)}catch(n){console.error("[Daily Scrum] Failed to encrypt temp buffer item:",n)}let a=[...e,...r];await chrome.storage.local.set({[c.SEND_QUEUE]:a})})}catch(t){console.error("[Daily Scrum] flushTempBufferToQueue error:",t)}}async function ie(){let{isLoggedIn:t,userId:o}=await chrome.storage.local.get([c.IS_LOGGED_IN,c.USER_ID]);return{isLoggedIn:t||!1,userId:o||null}}async function le(t,o=null){await chrome.storage.local.set({[c.IS_LOGGED_IN]:t,[c.USER_ID]:o})}async function _(){try{let{userId:t,serverSalt:o,authToken:e}=await chrome.storage.local.get([c.USER_ID,c.SERVER_SALT,c.AUTH_TOKEN]);if(!t)throw new Error("User ID not found in storage");let r=o,a=!1;if(!r){if(!e)throw new Error("Cannot initialize encryption without auth token");try{let s=await J(t,e);s?(r=s,await chrome.storage.local.set({[c.SERVER_SALT]:r}),console.log("[Daily Scrum] \u2705 Downloaded existing salt from server (multi-device sync)")):(r=await W(),a=!0,await chrome.storage.local.set({[c.SERVER_SALT]:r}),console.log("[Daily Scrum] \u2705 Generated new server salt (first login)"))}catch(s){throw console.error("[Daily Scrum] \u274C Failed to fetch salt from server:",s.message),chrome.notifications.create({type:"basic",iconUrl:"icons/icon-48.png",title:"Daily Scrum Connection Required",message:"Cannot verify encryption settings. Please check your internet connection and try again.",priority:2}),new Error("Cannot initialize encryption: server salt verification failed. This prevents data corruption.")}}if(await p.deriveKey(t,r),console.log("[Daily Scrum] \u2705 Encryption initialized"),a&&e)try{await H(t,r,e),console.log("[Daily Scrum] \u2705 Salt saved to Supabase")}catch(s){throw console.error("[Daily Scrum] \u274C Failed to save salt to Supabase after retries:",s),chrome.notifications.create({type:"basic",iconUrl:"icons/icon-48.png",title:"Daily Scrum Setup Failed",message:"Cannot connect to server. Please check your internet connection and try logging in again.",priority:2}),p.clearKey(),await chrome.storage.local.remove(c.SERVER_SALT),new Error("Failed to save encryption salt - cannot proceed without server synchronization")}}catch(t){throw console.error("[Daily Scrum] \u274C Failed to initialize encryption:",t),t}}async function H(t,o,e){for(let s=1;s<=3;s++)try{let n=await fetch(`${f}/rest/v1/user_encryption_salts`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`,apikey:g,Prefer:"resolution=ignore-duplicates"},body:JSON.stringify({user_id:t,salt:o})});if(n.ok||n.status===409)return;let i=await n.text();throw new Error(`HTTP ${n.status}: ${i}`)}catch(n){if(console.error(`[Daily Scrum] Salt save attempt ${s}/3 failed:`,n.message),s>=3)throw new Error(`Failed to save salt after 3 attempts: ${n.message}`);let i=1e3*Math.pow(2,s-1);console.log(`[Daily Scrum] Retrying in ${i}ms...`),await new Promise(l=>setTimeout(l,i))}}async function J(t,o){try{let e=await fetch(`${f}/rest/v1/user_encryption_salts?user_id=eq.${t}&select=salt`,{method:"GET",headers:{Authorization:`Bearer ${o}`,apikey:g}});if(!e.ok)throw new Error(`HTTP ${e.status}: ${await e.text()}`);let r=await e.json();return r&&r.length>0&&r[0].salt?r[0].salt:null}catch(e){throw console.error("[Daily Scrum] Failed to fetch salt from server:",e.message),e}}async function W(){return crypto.randomUUID()+crypto.randomUUID()}async function Y(t){let o=`${f}/functions/v1/ingest-data`;for(let e=0;e<w;e++)try{let r=await chrome.storage.local.get(["authToken"]);if(!r.authToken)return console.error("[Daily Scrum] \u274C No auth token in storage"),!1;let a={items:t},s=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r.authToken}`},body:JSON.stringify(a)});if(!s.ok){let n=await s.text();if(console.error("[Daily Scrum] - Error response:",n),s.status===401){let i=await U();if(i){let l=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify(a)});if(l.ok)return!0;let u=await l.text();throw new Error(`HTTP ${l.status} after token refresh: ${u}`)}}throw new Error(`HTTP ${s.status}: ${n}`)}return!0}catch(r){if(console.error(`[Daily Scrum] Send attempt ${e+1}/${w} failed:`,r.message),e<w-1){let a=B*Math.pow(2,e);await X(a)}}return console.error("[Daily Scrum] Failed to send data after",w,"attempts"),!1}function X(t){return new Promise(o=>setTimeout(o,t))}export{ie as getLoginState,le as setLoginState};
